{
  "queries": {
    "radd-cap-coverage-monitoring": {
      "type": "alerts",
      "description": "Monitors RADD CAP coverage vs AAR template consistency (Rolling Window: 1 month Shipment, 2 months AAR)",
      "schedule": "cron(0 8 * * ? *)",
      "query": "WITH radd_latest AS (SELECT cap, max_by(endvalidity, CAST(p_year || LPAD(p_month, 2, '0') || LPAD(p_day, 2, '0') AS integer)) as latest_validity FROM pn_radd_coverage_temp_json_view WHERE CAST(p_year || LPAD(p_month, 2, '0') || LPAD(p_day, 2, '0') AS integer) BETWEEN 20251215 AND CAST(DATE_FORMAT(current_date, '%Y%m%d') AS integer) GROUP BY cap, COALESCE(cadastralCode, '')), radd_con_date AS (SELECT cap, COALESCE(TRY_CAST(SUBSTR(TRIM(latest_validity), 1, 10) AS date), DATE('2999-12-31')) as data_scadenza FROM radd_latest), interestingShipment AS (SELECT iun, timestamp, details_numberofpages, details_physicaladdress_foreignstate, details_physicaladdress_zip, details_sentattemptmade, details_recindex, IF(details_numberofpages = '1', 'AAR_NOTIFICATION_RADD_ALT', IF(details_sentattemptmade = '0', 'AAR_NOTIFICATION', 'AAR_NOTIFICATION_OR_NOT')) AS aarGuessedType FROM pn_timelines_json_view WHERE category = 'SEND_ANALOG_DOMICILE' AND CAST(p_year || LPAD(p_month, 2, '0') || LPAD(p_day, 2, '0') AS integer) BETWEEN CAST(DATE_FORMAT(current_date - interval '1' month, '%Y%m%d') AS integer) AND CAST(DATE_FORMAT(current_date, '%Y%m%d') AS integer)), aar AS (SELECT iun, details_recindex, details_aarTemplateType AS aarType FROM pn_timelines_json_view WHERE category = 'AAR_CREATION_REQUEST' AND CAST(p_year || LPAD(p_month, 2, '0') || LPAD(p_day, 2, '0') AS integer) BETWEEN CAST(DATE_FORMAT(current_date - interval '2' month, '%Y%m%d') AS integer) AND CAST(DATE_FORMAT(current_date, '%Y%m%d') AS integer)), enrichedShipment AS (SELECT i.*, a.aarType, (r.cap IS NOT NULL AND details_physicaladdress_foreignstate = 'ITALIA' AND CAST(from_iso8601_timestamp(i.timestamp) AS date) <= r.data_scadenza) AS guessedRadd, aarGuessedType = 'AAR_NOTIFICATION_RADD_ALT' AS isRadd FROM interestingShipment i JOIN aar a ON i.iun = a.iun AND i.details_recindex = a.details_recindex LEFT JOIN radd_con_date r ON details_physicaladdress_zip = cap WHERE aarGuessedType != 'AAR_NOTIFICATION_OR_NOT'), analyis AS (SELECT (guessedRadd != isRadd) AS coverageError, (aarGuessedType != aarType) AS aarTemplateError, * FROM enrichedShipment) SELECT * FROM analyis WHERE aarTemplateError OR coverageError",
      "alerts": [
        {
          "name": "radd-coverage-mismatch",
          "threshold": {
            "operator": ">",
            "value": 0
          },
          "csv_export": true
        }
      ],
      "slack": {
        "enabled": true
      }
    }
  }
}